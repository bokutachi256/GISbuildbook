# クラウドとオープンソースを使った地理情報解析環境構築

---
[toc]
---
# 最初の一歩

## 地理情報解析に必要な環境とは

本書では，いわゆるGISのアプリケーションを使った環境構築は説明しません．
デスクトップ型GISでは対応のしにくい，
痒いところに手が届くような分析をしたい場合には，
やはり自分でプログラムを作成する必要があります．
本書ではそのようなニーズを満たすために，
コンピュータ上に地理情報解析のためのプログラミング環境を構築し，
その第一歩を踏み出すための手助けとなることを目的とします．

最近のデスクトップ型GIS（ArcGISやQGISなど）は非常に多機能になっており，
機能を組み合わせていけばやりたいことはほぼできると言ってもいいでしょう．
しかし，GUI（Graphical User Interface；マウスなどを使ってメニューを選択するようなインターフェイス）は
試行錯誤するには向いていますが，
違うデータに対して同じ処理を反復実行させたり，
分析の手順を記録として残すようなことには向いていません．
このような処理には，CUI（Character User Interface；コマンドを入力して実行するインターフェイス）の方が向いています．

デスクトップ型GISにもCUIが備わっていますが，
基本的にはそれぞれのGISの中で閉じているもので，
デスクトップ型GISが使える環境がないと利用できません．


一方で，汎用的なプログラミング環境はデスクトップ型GISとは独立しているため，
GISをインストールしなくても利用が可能です．
また，デスクトップ型のGISの機能を汎用的なプログラム言語から使用することができます．

これらのプログラミング言語はプログラムを作成するエディタと
プログラムを実行するコンパイラないしはインタプリタを組み合わせて使います．
C言語はコンパイラ型の言語であり，
作成したプログラムを実行するにはコンパイラを用いて実行形式（アプリケーションのようなもの）に変換する必要がありますが，
PythonやRはインタプリタ型の言語であるため，実行形式に変換する必要がなく，
プログラムを変更してすぐに実行することができます．

一般的にプログラミングはエディタと呼ばれるプログラム作成ソフトを使いますが，
統合環境と呼ばれるプログラミング専用のエディタを使うこともできます．
統合環境はプログラミングに便利な仕組みが備わっており，
例えば変数の内容をリアルタイムに表示するウオッチ機能，
好きな場所もしくは指定した条件の時にプログラムの実行を止めるブレーク機能などがあります．

PythonやR言語にも統合環境が用意されています．
例えば，eclipseやNetBeansなどは汎用的な統合環境であり，
モジュールを組み込むことによりPythonやRのプログラムを作成することができます．
ただ，これらの統合環境を導入するのはプログラミング初心者にはややハードルが高いと言えます．
いくつかの統合環境は実行するためにJAVAなどの
仕組みをインストールする必要があり，
少し詳しい知識が必要になります．

これに対して，PythonやR専用の統合環境も用意されています．
PythonにはJupyter Notebook，RにはRStudioがあります．
どちらもインストールは比較的簡単で，
導入にあたってつまずくような部分はほとんどないでしょう．

Jupyter NotebookやRStudioはノートブックという型式を採用しており，
プログラムと一緒にメモを書き込めるようになっています．
また，Jupyter NotebookもRStudioもプログラムを「チャンク」という単位で記入でき，
チャンクごとにプログラムを実行し結果を確認することができます．
もちろんどのチャンクを実行するかは自由に選べます．
このためプログラムを修正した部分だけを実行し，
その実行結果を逐一確認することができます．
チャンクをうまく使うことにより，試行錯誤の結果を記録として残すことができます．
このため非常に生産性の高いプログラミングをすることができます．

ノートブックはプログラムのコードを書く部分，
実行結果が表示される部分，メモ書きができる部分に分かれています．
このうちメモを書く部分にはMarkdownという形式で記入ができます．
Markdownはメモ本文とその構造（見出し，箇条書き，表組など）を一緒に記入していく方法です．
ホームページを作成するときに使うHTMLと似ていますが
タグの代わりに直感的で簡単な記号を入力します．
これにより，文章と関係のないタグを挿入する煩わしさから開放されます．

> **メモ：** 以上のことから，本書ではJupyter NotebookとRStudioを使った地理情報解析環境の構築について述べていきます．




### Diagrams
#### Flow charts
```flow
st=>start: Start
e=>end
op=>operation: My Operation
cond=>condition: Yes or No?



st->op->cond
cond(yes)->e
cond(no)->op
```

```flow
st=>start: スタート
e=>end: 終了
op=>operation: 質問
cond=>condition: 終了条件
nd=>operation: 計算

st->op->nd->cond
cond(yes)->e
cond(no)->nd
cond(true)->nd
```


#### Sequence diagrams
```sequence
Alice->Bob: Hello Bob, how are you?
Note right of Bob: Bob thinks
Bob-->Alice: I am good thanks!
```


#### Sequence diagrams
```sequence
Alice->Bob: Hello Bob, how are you?
Note right of Bob: Bob thinks
Bob-->Alice: I am good thanks!
Bob-->John: thanks
John-->Alice: good
```





### RStudioとJupyter Notebook

### RStudio

R言語とは，統計計算用の言語です．
商用のS-Plus言語との互換を目的に開発が始まったもので，
現在では非常に人気の高い言語となっています．
ただ，目的が統計計算であるため，アプリケーションを開発したりする用途には向いていません．
また，並列計算の機能が未実装（ユーザーコミュニティによる並列計算機能も開発されている）です．
オープンソースのプロジェクトであり，誰でも利用が可能なために
R言語を本体を取り巻く部分での商用化もされています．
例えば，マイクロソフトも自社のデータベースであるSQL ServerでのR言語のサポートを行っていますし，
本書で紹介するRStudioも統合環境のサポート部分での商用化をしています．

RStudioを使うためにはR本体をインストールしなくてはなりません．
R本体はrjpwikiやrstudio.comからラウンロードが可能です．
R本体をインストールした後にRStudioをインストールします．

RStudioにはいくつか種類があります．

通常はフリーで使えるバージョンを使えば問題はないでしょう．
本稿ではLinux環境にサーババージョンのRStudioであるRStudio Serverをインストールします．

Rではライブラリという仕組みで機能を拡張することができます．
ライブラリはユーザーコミュニティにより開発されているものが多く，
無料で使用できるものがほとんどです．

例えば，本書で紹介するRのライブラリには以下のものがあります．

##### dplyr・tidyr

Rの特徴であるデータフレームの処理に特化したライブラリです．
dplyerを使えばデータフレームの検索，集計などが高速に行えます．
tidyrはデータフレームの形状を変更するライブラリです．
これを使えば横持ち・盾持ちの変換などが簡単にできます．
以前は`rehsape2`というライブラリがよく使われていましたが，
`tidyr`は`reshape2`の後継ライブラリになります．

##### RMySQL

リレーショナルデータベースの一つであるMySQL（MariaDB）を
Rから使えるようにするライブラリです．
リレーショナルデータベースは大量のデータを効率よく
保持・管理・検索できるシステムで，
それをRから使用できると非常にべんりになります．

##### ggmap

座標で与えられたデータをGoogle Mapに表示できるライブラリです．

##### qgraph

ネットワークを表すグラフデータを分析できるライブラリです．
分析の他にもネットワークを表すグラフを書くことができます．

##### RMeCab

形態素解析を行うソフトであるMeCabをRから呼び出せるライブラリです．

###### igraph

ネットワークグラフを処理できるライブラリです．
ネットワーク中のどのノードが重要性などを計算できます．

##### ggplot2

グラフ作成ライブラリです．
多彩なグラフを作れます．


### Jupyter Notebook
- anaconda
- Jupyter Notebook
- gdal
- joblib
- pandas
- geopandas
- networkx
- geocoder
- geojson
- geoplot
- georaster
- georasters
- graphviz

### リレーショナルデータベース（PostgreSQL，MariaDBなど）
-
数式のテスト

これはインラインの数式です．
こんな感じです．
変数$r$みたいにやるのです．

円周率 $\pi$ $\sum$

$$\frac{1}{2}$$

$$\sum^{1}_{2}$$



$$\int^{\inf}_{-\inf} f(x)dx$$

```r
library(reshape2)
library(data.table)
library(dplyr)

# 読み込むデータファイルの指定
#始点がa，終点がbの距離行列
abfile = "od_ie_ittoki.txt"
# 始点がb，終点がcの距離行列
bcfile = "od_ittoki_hinan.txt"
# 始点がa，終点がcの距離行列
acfile = "od_iehinan.txt"

# データの読み込み
# すべてのaからすべてのbまでの距離行列
ab <- fread(abfile, header = T, encoding = "UTF-8", stringsAsFactors = F)
# すべてのbからすべてのcまでの距離行列
bc <- fread(bcfile, header = T, encoding = "UTF-8", stringsAsFactors = F)
# すべてのbからすべてのcまでの距離行列
ac <- fread(acfile, header = T, encoding = "UTF-8", stringsAsFactors = F)
```

Rstudioはフリーの統計ソフトであるRを使いやすくするためのアプリケーションです．
Rはコマンドを入力して実行していくため，
慣れていない人にはややハードルが高いと言えます．
また，変数などの内容を確認するのにもコマンドを入力する必要があります．

RStudioはRを使いやすくするためのアプリケーションです．

![](introduction/b847a5e5de15e333ce4d13dce6735f01.png)

#### Jupyter Notebook

Jupyter Notebookとは，Pythonの開発環境です

```python
import json
import urllib.parse
stat_tab = {}
for u in range(len(class_obj[2]['CLASS'])):
    stat_tab[class_obj[2]['CLASS'][u]['@code']] = {i: u'' for i in col_name}

# 人口データの埋め込み
for i in range(len(stat_obj)):
    stat_tab[stat_obj[i]['@area']]['KEY_CODE'] = stat_obj[i]['@area']
    stat_tab[stat_obj[i]['@area']]['HTKSYORI'] = stat_obj[i]['@cat02']
    stat_tab[stat_obj[i]['@area']][stat_obj[i]['@cat01']] = stat_obj[i]['$']


# 内包表記を使った欠損値処理
tab_all = [[str(tab_all[u][i]).replace('-', '0') for i in range(len(tab_all[0]))] for u in range(len(tab_all))]

# csvファイルへの書き出し
f = codecs.open(tab_info['@id']+'.txt', 'w')
csv_writer = csv.writer(f)
csv_writer.writerow(col_name)
csv_writer.writerows(tab_all)
f.close()
```

![](introduction/0d29508306fc198beab1888d22bb3b7b.png)

## どのような環境を構築するか

まず考えられるのは，WindowsやMacの上に直接環境を構築することです．
これはWindowsないしMacにアプリケーションとしてのRやRStudioを直接インストールします．

この方法ですと，それぞれのアプリケーションはそれぞれのOSの上で最大限の性能を発揮することができます．
ただし，WindowsにはWindowsの，MacにはMac固有の「クセ」があるため，
そのクセをうまく回避して環境を構築する必要があります．
例えば，Windowsには日本語文字コードの問題があります．
最近のPC環境では，Unicode（ユニコード）という文字コードが使われていますが，
WindowsはMS-DOS時代からの経緯があって，
日本語はシフトJISという文字コードが根底にあります（正確にはCP932という文字コードになります）．

古いWindows（Windows Meまで）はシフトJISで動いていましたが，
Windows NTをベースにしたOS（Windows 2000以降）は，
OSの内部ではユニコード（UTF-16）で統一されています．
ただし，古いアプリケーションやファイルシステムとの互換性の問題から，
現在のWindows（Windows10など）では，シフトJISとユニコード（UTF-8など）が混在しています．
この混在が非常に厄介で，RやPythonなどで日本語を扱う際に大きな障壁になっています．

MacはOS Xになってから完全にユニコードになったため，
日本語の文字コードの問題は起こりにくくなっています．
ただし，RやPythonで日本語を表示する際にフォントを特別に指定ないと文字化けが起きる可能性があります．
例えばMac上のRであるグラフを作成するスクリプトを作る場合，
Macに特有の命令を入れなければ日本語が正常に表示されません．
Macだけを使っている場合は特に問題はないのですが，
そのスクリプトをWindows上のRで動かす場合に，
Mac特有の命令の部分でエラーが発生してしまいます．

Linux ではこのよう問題はほとんど起きません．
OSの内部でもユニコードを使っており，
これが標準の環境になっています．
このような理由から，私はLinuxに環境を構築することをお勧めします．

## どこに環境を作るか

それではLinuxに環境を構築する前提で話を進めましょう．

どのマシンに環境を構築するかは大きな問題です．
おそらく本書の読者は自分のPCを持っていると思いますが，
人によってはノートPCやタブレットPCに近い3-in-1を使っている人もいるかと思います．
一般的にノートPCはデスクトップPCよりも性能が低いものが多く，
タブレットPCは更に性能が低くなります．

所有しているPCにLinux環境を構築する場合，
構築するPC（ホストPC）の性能を超えることはできません．

| 項目        | 専用PCを導入            | 手持ちのPC                 | 仮想マシン               | クラウド               |
| --------- | ------------------ | ---------------------- | ------------------- | ------------------ |
| 費用        | 費用がかかる             | かからない                  | かからない               | 使った分だけかかる          |
| 構築のしやすさ   | 最初は苦労するが安定した環境を作れる | とりあえず動かせるようになるが，そのうち困る | 最初は苦労するが安定した環境を作れる  | 最初は苦労するが安定した環境を作れる |
| 実行速度      | 速い                 | まあまあ速い                 | まあまあ速い              | お金次第でスパコン並みになる     |
| PC買い換えの場合 | 最初から作り直し           | 最初から作り直し               | 仮想マシンのイメージをコピーすれば良い | 買い換えは生じない          |

## クラウドコンピューティングとは

AWS（Amazon Web Service）は，クラウドのコンピューティング環境です．
自分のPCが非力だとしても，
クラウドのマシンを使うことでタブレット並みの性能から
スパコン並みの性能まで自由自在に使うことができます．

なぜならクラウド上のマシンは仮想マシンであり，
物理的な実機ではないからです．
言うなればコンピュータ自体がソフトウエアとして稼働しており，
普段我々が使うようなPCには実態があるのに対し，
クラウドコンピュータは実体のない「仮想的」なコンピュータと言えます．

クラウドコンピュータのユーザーはこのような「仮想」コンピュータに
インターネットを使ってアクセスします．
アクセスする先がどこにあるのか意識する必要はほとんどありません．

私達のような一般のユーザーにとって，
クラウドコンピュータを利用するメリットは何でしょう．
私は以下の3点があると考えています．

1. ハードウエアを維持しなくてもよい
2. 必要に応じて計算機パワーを変えることができる
3. 使った分だけお金を払えば良い

以上の3点について，以下で説明していきます．

### ハードウエアを維持しなくてもよい

ハードウエアを維持しなくてもよいということは，
ハードウエアを買う必要がないということです．
ハードウエアを買わなければ，ハードウエアに関するすべての
コストがかからないことを意味します．
つまり，電気代もかからなければ，
故障した時の修理代もかからず，
物理的な置き場所も必要ありません．

これはハードウエアの故障を気にしなくてもよいことです．
例えば，手元のPCに解析環境を作成することを考えてみましょう．
WindowsなりMacなり，自分のPCに苦労してソフトウエアをインストールし，
分析できる環境を作ったとします．
あるとき不幸なことにそのPCがクラッシュしてしまいました．
あなたは泣く泣くPCを修理に出します．
しかし，修理されて戻ってきたPCは工場出荷時に戻されているのです．

幸いにもデータはバックアップを取っていたため大きな影響はなかったのですが，
ソフトウエアはすべてインストールし直しです．
細かい設定などはバックアップを取っていなかったため，
元の環境に戻すのに大変手間がかかりました．

これは悲観的なシチュエーションですが，
もっと前向きな状況もあり得ます．
例えば，今まで使っていたPCが非力になってきたため，
性能の良いPCに買い換える場合です．
この場合もソフトウエアの再インストールが必要になるでしょう．

このように，せっかく自分のPCに環境を作っても，
もしそのPCが故障してしまったり，
PCの買い換えなどの場合には環境を作りなおす必要があります．
しかし，クラウドではマシンの故障を心配する必要はありません．

なぜなら，クラウドコンピュータのハードウエアは
サービスを提供している会社が管理しており，
ユーザーが気にする必要がないからです．
例えハードウエアがクラッシュしたとしても，
それを修理するのはサービス会社の役割であって，
ユーザーは故障したことすらわかりません．

ハードウエアの維持は（精神的にも）大変コストのかかるものであり，
それから開放されるだけでも大きなメリットがあります．

### 必要に応じて計算機パワーを変えることができる

皆さんはPCを買うときにどのような点を考えて機種を選ぶでしょうか．
大多数の人は性能と価格のバランスを考えて買うと思います．
一般的に性能の良いPCは値段が高く，安いPCは性能が控えめです．
自分に必要な性能はどのくらいなのか，
安いPCで十分なのか，それとも高性能なPCが必要なのか，
値段に見合った使いこなしができるのか，
いろいろと気になるところです．
普段は性能が控えめのPCで十分でも，
もしかすると時間がかかる計算をする事があるかもしれません．

クラウドコンピュータはこのような問題を簡単に解決できます．
普段は性能が控えめの安いクラウドコンピュータを使い，
いざ複雑な計算をするときには高機能なマシンに切り替えることができます．
それもクリックを数回するだけで変更が可能です．

これはまさにコンピュータが仮想化されてるからこそできることです．
もちろん，高性能なマシンを使う場合はその分料金がかかりますが，
気をつけていればそれほど高額になることはないと思います．

このように，クラウドコンピュータでは
スケーラブルなコンピュータ環境を利用できます．
分析専用のPCを購入したり，手持ちのPCに環境を構築する場合，
そのPCの性能より速い環境を作ることはできません．
しかし，クラウドにPC環境を構築すれば，
手元にあるPCよりも高性能なコンピュータを使うことができます．
複雑な計算をする場合には有力な選択肢になるでしょう．

代表的なクラウドコンピューティング環境には、AmazonがサービスしているAWS（Amazon Web Seに必要な環境とは
本書では，いわゆるGISのアに必要な環境とは
本書では，いわゆるGISのアrvice）、マイクロソフトがサービスしているAzure、GoogleがサービスしているGCP（Google Computing Platform）などがあります。
どのサービスにも無料のお試し期間がありますので、
興味がある方は試してみてください。

ちょっとした追加。
ちょっとした追加その2。
ちょっとした追加その3．


![](introduction/533634741c295604a3d8504d6ddcb047.png)
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTM0NzAyNDc2NF19
-->